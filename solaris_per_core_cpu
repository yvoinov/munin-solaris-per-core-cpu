#!/usr/bin/perl -w
# -*- perl -*-
#
# Munin plugin for Solaris — per-core CPU usage (user/kernel)
#
# Can output either percentages (default) or raw ticks (set env.graph_ticks=1)
# Shows per-core CPU activity using cpu_ticks_user/kernel from kstat (instance sys)
#
# CONFIGURATION:
# In /etc/opt/csw/munin/plugin-conf.d/plugins.conf:
#   [solaris_per_core_cpu]
#   env.graph_ticks 0     # 0 = percent (default), 1 = ticks
#   user root             # must be run as root to access kstat data

use strict;
use warnings;

my $KSTAT = "/bin/kstat -p cpu:::cpu_ticks_*";
$ENV{'PATH'} = '/bin:/usr/bin';

my $graph_ticks   = $ENV{'graph_ticks'} || 0; # 0 = show percents, 1 = ticks
my $ticks_per_sec = 100; # typical Solaris tick rate
my $statfile      = "/var/tmp/munin_solaris_cpu_ticks.dat";

# --- CONFIG MODE ---
if (@ARGV && $ARGV[0] eq 'config') {
    print "graph_title Per-core CPU usage (user/kernel)\n";
    print "graph_category system\n";
    print "graph_args --base 1000 -r --lower-limit 0\n";
    print "graph_scale no\n";

    if ($graph_ticks) {
        print "graph_vlabel delta ticks per interval\n";
        print "graph_info Shows per-core CPU activity in ticks per interval (user & kernel)\n";
    } else {
        print "graph_vlabel % utilization\n";
        print "graph_info Shows per-core CPU usage as percentage of time spent in user & kernel modes\n";
    }

    my %cpu_seen;
    open(my $ks, "$KSTAT |") or die "cannot run kstat: $!";
    while (<$ks>) {
        if (/^cpu:(\d+):sys:cpu_ticks_(user|kernel)\s+\d+/) {
            $cpu_seen{$1} = 1;
        }
    }
    close($ks);

    foreach my $cpu (sort { $a <=> $b } keys %cpu_seen) {
        print "user${cpu}.label cpu${cpu} user\n";
        print "user${cpu}.type GAUGE\n";
        print "user${cpu}.draw LINE1\n";
        print "kernel${cpu}.label cpu${cpu} kernel\n";
        print "kernel${cpu}.type GAUGE\n";
        print "kernel${cpu}.draw LINE1\n";
    }
    exit 0;
}

# --- DATA COLLECTION ---
sub read_kstat_ticks {
    my %data;
    open(my $fh, "$KSTAT |") or die "cannot run kstat: $!";
    while (<$fh>) {
        if (/^cpu:(\d+):sys:cpu_ticks_(user|kernel)\s+(\d+)/) {
            $data{$1}{$2} = $3;
        }
    }
    close($fh);
    return \%data;
}

sub read_prev_stat {
    my %out;
    return %out unless -s $statfile;
    open(my $fh, "<", $statfile) or return %out;
    while (<$fh>) {
        if (/^(\d+)\s+(user|kernel)\s+(\d+)\s+([\d.]+)/) {
            $out{$1}{$2} = $3;
            $out{'_time'} = $4;
        }
    }
    close($fh);
    return %out;
}

sub write_stat {
    my ($ticks) = @_;
    my $time = time();
    open(my $fh, ">", $statfile) or die "cannot write $statfile: $!";
    foreach my $cpu (sort { $a <=> $b } keys %$ticks) {
        next if $cpu eq '_time';
        print $fh "$cpu user $ticks->{$cpu}{user} $time\n";
        print $fh "$cpu kernel $ticks->{$cpu}{kernel} $time\n";
    }
    close($fh);
}

# --- main ---
my $curr = read_kstat_ticks();
my %prev = read_prev_stat();

my $now = time();
my $dt = $now - ($prev{'_time'} || ($now-1)); # avoid division by zero
$dt = 1 if $dt <= 0;

foreach my $cpu (sort { $a <=> $b } keys %$curr) {
    my $du = ($curr->{$cpu}{user}   || 0) - ($prev{$cpu}{user}   || 0);
    my $dk = ($curr->{$cpu}{kernel} || 0) - ($prev{$cpu}{kernel} || 0);

    $du = 0 if $du < 0;
    $dk = 0 if $dk < 0;

    if ($graph_ticks) {
        print "user${cpu}.value $du\n";
        print "kernel${cpu}.value $dk\n";
    } else {
        my $pu = sprintf("%.2f", $du * 100 / ($ticks_per_sec * $dt));
        my $pk = sprintf("%.2f", $dk * 100 / ($ticks_per_sec * $dt));
        print "user${cpu}.value $pu\n";
        print "kernel${cpu}.value $pk\n";
    }
}

write_stat($curr);
